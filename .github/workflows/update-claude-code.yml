name: Update Claude Code

on:
  schedule:
    - cron: "0 8 * * *" # Daily at 8am UTC
  workflow_dispatch: {}

jobs:
  check-update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Check for new version
        id: check
        run: |
          CURRENT=$(grep 'version ? "' modules/home-manager/packages/claude-code.nix | sed 's/.*version ? "\(.*\)"/\1/')
          LATEST=$(curl -s https://registry.npmjs.org/@anthropic-ai/claude-code/latest | jq -r '.version')
          echo "current=$CURRENT" >> "$GITHUB_OUTPUT"
          echo "latest=$LATEST" >> "$GITHUB_OUTPUT"
          if [ "$CURRENT" != "$LATEST" ]; then
            echo "update=true" >> "$GITHUB_OUTPUT"
          else
            echo "update=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Prefetch hashes
        if: steps.check.outputs.update == 'true'
        id: hashes
        run: |
          VERSION="${{ steps.check.outputs.latest }}"
          BASE_URL="https://storage.googleapis.com/claude-code-dist-86c565f3-f756-42ad-8dfa-d59b1c096819/claude-code-releases/${VERSION}"

          DARWIN_ARM64=$(nix-prefetch-url "${BASE_URL}/darwin-arm64/claude" 2>/dev/null)
          DARWIN_X64=$(nix-prefetch-url "${BASE_URL}/darwin-x64/claude" 2>/dev/null)
          LINUX_X64=$(nix-prefetch-url "${BASE_URL}/linux-x64/claude" 2>/dev/null)
          LINUX_ARM64=$(nix-prefetch-url "${BASE_URL}/linux-arm64/claude" 2>/dev/null)

          echo "darwin_arm64=$DARWIN_ARM64" >> "$GITHUB_OUTPUT"
          echo "darwin_x64=$DARWIN_X64" >> "$GITHUB_OUTPUT"
          echo "linux_x64=$LINUX_X64" >> "$GITHUB_OUTPUT"
          echo "linux_arm64=$LINUX_ARM64" >> "$GITHUB_OUTPUT"

      - name: Update claude-code.nix
        if: steps.check.outputs.update == 'true'
        run: |
          VERSION="${{ steps.check.outputs.latest }}"
          FILE="modules/home-manager/packages/claude-code.nix"

          sed -i "s|version ? \"[^\"]*\"|version ? \"${VERSION}\"|" "$FILE"
          sed -i "s|\"darwin-arm64\" = \"[^\"]*\"|\"darwin-arm64\" = \"${{ steps.hashes.outputs.darwin_arm64 }}\"|" "$FILE"
          sed -i "s|\"darwin-x64\" = \"[^\"]*\"|\"darwin-x64\" = \"${{ steps.hashes.outputs.darwin_x64 }}\"|" "$FILE"
          sed -i "s|\"linux-x64\" = \"[^\"]*\"|\"linux-x64\" = \"${{ steps.hashes.outputs.linux_x64 }}\"|" "$FILE"
          sed -i "s|\"linux-arm64\" = \"[^\"]*\"|\"linux-arm64\" = \"${{ steps.hashes.outputs.linux_arm64 }}\"|" "$FILE"

      - name: Create Pull Request
        if: steps.check.outputs.update == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: "chore: update claude-code to ${{ steps.check.outputs.latest }}"
          title: "chore: update claude-code to ${{ steps.check.outputs.latest }}"
          body: |
            Updates Claude Code from `${{ steps.check.outputs.current }}` to `${{ steps.check.outputs.latest }}`.

            [Release notes](https://github.com/anthropics/claude-code/releases)
          branch: update-claude-code
          delete-branch: true
